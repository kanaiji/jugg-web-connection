#!groovy
pipeline{
    
    agent any
    
    environment{
    
        REPOSITORY = "https://github.com/kanaiji/jugg-web-connection.git"
        ROOT = "/root/.jenkins/workspace"
        MOUDEL_CONNECTION = "jugg-web-connection"
        SCRIPT_PATH="/root/.jenkins/workspace/jugg-web-connection/cicd"
        DEPLOYMENT_APP_JUGG_CONNECTION="jugg-web-connection-deployment"
        OPERATE_APPLY = "apply"
        OPERATE_update = "update"
    }
    
    stages{
        
        stage('´úÂëÀ­È¡'){
            steps{
                echo "start fetch code from git:${REPOSITORY}"
                deleteDir()
                git credentialsId: 'jugg-connection', url:"${REPOSITORY}"
            }
        }
        
        stage('connection moudle: docker'){
            steps{
                echo "build.sh...set fileformat=unix"
                sh "dos2unix ${ROOT}/${MOUDEL_CONNECTION}/cicd/build.sh"
                
                echo "chmod 777 ${ROOT}/${MOUDEL_CONNECTION}/cicd/build.sh..."
                sh "chmod 777 ${ROOT}/${MOUDEL_CONNECTION}/cicd/build.sh"
                
                echo "start docker build -t ..${ROOT}${MOUDEL_CONNECTION}/"
                sh "${ROOT}/${MOUDEL_CONNECTION}/cicd/build.sh ${ROOT}"
           
            }
        }
        
        stage('connection moudle: deploy'){
            steps{
                echo "start deploy.."
                echo "build.sh...set fileformat=unix"
                sh "dos2unix ${SCRIPT_PATH}/deploy.sh"
                
                echo "chmod 777 ${ROOT}/${MOUDEL_CONNECTION}/cicd/deploy.sh..."
                sh "chmod 777 ${ROOT}/${MOUDEL_CONNECTION}/cicd/deploy.sh"
                sh "${ROOT}/${MOUDEL_CONNECTION}/cicd/deploy.sh ${DEPLOYMENT_APP_JUGG_CONNECTION} ${OPERATE_APPLY}"
            }
        }
        
    }
   
    
}


